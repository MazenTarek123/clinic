import streamlit as st

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… (Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ©) ---
st.set_page_config(page_title="Cure & Go | Doctor Portal", page_icon="ğŸ‘¨â€âš•ï¸", layout="wide")

st.markdown("""
<style>
.stApp { background: linear-gradient(135deg, #f5f7fa, #c3cfe2); font-family: 'Segoe UI', sans-serif; }
.main-title { font-size: 42px; font-weight: 800; text-align: center; color: #1f2937; margin-bottom: 10px; }
.doctor-info { background: white; padding: 20px; border-radius: 15px; border-left: 5px solid #2563eb; margin-bottom: 20px; }
.stButton>button { border-radius: 10px; transition: 0.3s; }
</style>
""", unsafe_allow_html=True)

# --- Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Session State ---
# Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ¹Ø±Ù ÙÙŠ Ù…Ù„Ù main.py ÙˆØªÙ†ØªÙ‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
if "doctors" not in st.session_state:
    st.error("No doctors found in system memory.")
    st.stop()

if "appointments" not in st.session_state:
    st.session_state.appointments = []

# Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„Ù€ schedule Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù„Ø£Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„ÙŠÙ‡Ø§)
for doc in st.session_state.doctors:
    if not hasattr(doc, 'schedule'):
        doc.schedule = {day: ["available"] * 24 for day in ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]}

# ---------------------------------------------------------
# Doctor Portal Logic
# ---------------------------------------------------------

def doctor_portal():
    st.markdown("<div class='main-title'>ğŸ‘¨â€âš•ï¸ Doctor Portal</div>", unsafe_allow_html=True)

    # --- 1. Login Logic ---
    if st.session_state.get('logged_in_doctor_id') is None:
        col1, col2, col3 = st.columns([1, 1.5, 1])
        with col2:
            st.subheader("Login to your account")
            with st.form("doctor_login"):
                doc_id_input = st.text_input("Enter Doctor ID (e.g., 001)", max_chars=3)
                submitted = st.form_submit_button("Access My Dashboard", use_container_width=True)

                if submitted:
                    found_doc = next((d for d in st.session_state.doctors if d.doctor_id == doc_id_input), None)
                    if found_doc:
                        st.session_state['logged_in_doctor_id'] = found_doc.doctor_id
                        st.success(f"Welcome, Dr. {found_doc.name}!")
                        st.rerun()
                    else:
                        st.error("Invalid ID. Please check with administration.")
        return

    # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
    current_doc_id = st.session_state['logged_in_doctor_id']
    current_doc = next(d for d in st.session_state.doctors if d.doctor_id == current_doc_id)

    # --- 2. Sidebar & Navigation ---
    with st.sidebar:
        st.markdown(f"### Welcome, \n## Dr. {current_doc.name}")
        st.info(f"ğŸ“ Room: {current_doc.room}\n\nğŸ“ {current_doc.specialization}")
        st.write("---")
        menu = st.radio("Go to:", ["ğŸ“… My Appointments", "âš™ï¸ Manage Availability", "ğŸšª Logout"])

    # --- 3. Dashboard Sections ---
    
    # Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„: Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
    if menu == "ğŸ“… My Appointments":
        st.subheader("Scheduled Patient Appointments")
        
        # ØªØµÙÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙ‚Ø·
        my_appts = [
            app for app in st.session_state.appointments 
            if app.get('doctor_id') == current_doc.doctor_id or app.get('doctor') == current_doc.name
        ]

        if my_appts:
            display_data = []
            for i, app in enumerate(my_appts, 1):
                display_data.append({
                    "Seq": i,
                    "Patient": app.get('patient_name'),
                    "Disease": app.get('disease', 'General Checkup'),
                    "Day": app.get('day'),
                    "Time": f"{app.get('hour')}:00",
                    "Contact": app.get('patient_phone')
                })
            st.table(display_data)
        else:
            st.info("You don't have any appointments booked yet.")

    # Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„
    elif menu == "âš™ï¸ Manage Availability":
        st.subheader("Update Your Work Hours")
        st.write("Click on a time slot to toggle between **Open** (Available) and **Closed**.")
        
        selected_day = st.selectbox("Select Day", list(current_doc.schedule.keys()))
        
        col1, col2, col3, col4 = st.columns(4)
        day_schedule = current_doc.schedule[selected_day]
        
        for i in range(24):
            # ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø¹Ù„Ù‰ 4 Ø£Ø¹Ù…Ø¯Ø©
            if i < 6: col = col1
            elif i < 12: col = col2
            elif i < 18: col = col3
            else: col = col4
            
            status = day_schedule[i]
            hour_label = f"{i:02d}:00"
            
            with col:
                if status == "booked":
                    st.button(f"ğŸ”’ {hour_label}\nBOOKED", key=f"bk_{i}", disabled=True)
                else:
                    is_open = (status == "available")
                    btn_type = "primary" if is_open else "secondary"
                    label = f"âœ… {hour_label}\nOpen" if is_open else f"â›” {hour_label}\nClosed"
                    
                    if st.button(label, key=f"btn_{selected_day}_{i}", use_container_width=True):
                        current_doc.schedule[selected_day][i] = "not available" if is_open else "available"
                        st.rerun()

    # Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    elif menu == "ğŸšª Logout":
        st.session_state['logged_in_doctor_id'] = None
        st.rerun()

if __name__ == "__main__":
    doctor_portal()
